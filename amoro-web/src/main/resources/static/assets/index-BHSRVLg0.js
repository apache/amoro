
/*
  * Licensed to the Apache Software Foundation (ASF) under one
  * or more contributor license agreements.  See the NOTICE file
  * distributed with this work for additional information
  * regarding copyright ownership.  The ASF licenses this file
  * to you under the Apache License, Version 2.0 (the
  * "License"); you may not use this file except in compliance
  * with the License.  You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */

import{e as we,K as j,a as te}from"./monaco-DM8nFf3H.js";import{d as N,w as se,j as oe,o as ae,y as $e,X as o,a0 as p,a1 as E,c as ne,a3 as u,V as y,a2 as b,a6 as k,af as V,u as Le,F as R,aa as M,f,r as F,ae as Oe,W,k as q,Y as H,m as Re,A as Ie,G as Me}from"./vue-KZ6HWXOH.js";import{_ as A,r as I,a as Te}from"./index-C3lMfZSI.js";import{d as le}from"./common.type-BplHNJCB.js";import{N as ue,e as ie,O as re,a as B,b as De,s as He,B as Ee}from"./antd-CPSoav-4.js";import{g as Fe}from"./table.service-CoshcICY.js";import{u as Be}from"./usePlaceholder-DDdrf-Dx.js";import"./pinia-BCc-Ghqu.js";import"./dayjs-DZyl58SH.js";import"./sql-BwF-LpWF.js";import"./axios-B4uVmeYG.js";const Ve={theme:"arcticSql",language:"sql",fontSize:12,lineHeight:24,fontFamily:'Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace',folding:!0,suggestLineHeight:20,autoIndent:!0,renderLineHighlight:"all",scrollBeyondLastLine:!1,contextmenu:!1,readOnly:!0,fixedOverflowWidgets:!0},Ne=Object.assign({},Ve,{theme:"arcticSql",language:"sql",readOnly:!1,lineHeight:24,fontSize:12,fontFamily:'Monaco, Menlo, "Ubuntu Mono", Consolas, source-code-pro, monospace',lineNumbersMinChars:3,wordWrap:"on",renderLineHighlight:"all",minimap:{enabled:!1},contextmenu:!1,automaticLayout:!0,scrollBeyondLastLine:!1}),Ae=N({__name:"index",props:{sqlValue:{},options:{},readOnly:{type:Boolean}},emits:["save","update:value","change"],setup(e,{expose:n,emit:m}){const d=e,c=m;let a,_="";const l={};se(()=>d.sqlValue,s=>{s&&_!==s&&a&&a.setValue(s)}),window.addEventListener("resize",v);function v(){a&&a.layout()}n({executeCommand(s){const r=l[s],C=a;r&&C&&C._commandService.executeCommand(r)},updateOptions(s={}){a&&a.updateOptions(s)},getSelection(){const s=a.getSelection(),r=a.getModel();return s&&r?r.getValueInRange(s):""}}),oe(()=>{window.removeEventListener("resize",v),a&&a.dispose()}),ae(()=>{const s=document.getElementsByClassName("m-sql-editor")[0];$e(()=>{const r=a=we.create(s,{...Ne,...d.options});h(),r.setValue(d.sqlValue||""),r.onDidChangeModelContent(()=>{const C=a.getValue();c("update:value",C),c("change",C),_=C})})});function h(){if(a){const s=a.addCommand(j.CtrlCmd|te.KeyS,()=>{c("save")});l.save=s;const r=a.addCommand(j.Alt|j.Shift|te.KeyF,()=>{S()});l.format=r}}function S(){const s=a&&a.getAction("editor.action.formatDocument");s&&s.run()}return(s,r)=>(o(),p("div",{class:E(["m-sql-editor",{disabled:s.readOnly}]),style:{height:"100%",width:"100%"}},null,2))}}),ce=A(Ae,[["__scopeId","data-v-a9960d6c"]]),ze={class:"sql-result-wrap"},Ue={class:"g-ml-8"},Ke={key:0,class:"empty"},Pe={key:1,class:"result-wrap"},je={class:"ant-table sql-result-table",style:{width:"100%"}},We={class:"ant-table-thead"},Ye={class:"ant-table-tbody"},Ge=["title"],Je=N({__name:"sql-result",props:{info:{}},setup(e){const n=e,m=ne(()=>{var c;return!n.info||!((c=n.info)!=null&&c.columns)}),d=ne(()=>{var c;return(c=n.info)==null?void 0:c.status});return(c,a)=>{const _=ue,l=ie,v=re;return o(),p("div",ze,[u("div",{class:"result-status",style:V({background:Le(le)[d.value]})},[d.value==="Running"?(o(),y(_,{key:0,style:{color:"#1890ff"}})):b("",!0),d.value==="Canceled"||d.value==="Failed"?(o(),y(l,{key:1,style:{color:"#ff4d4f"}})):b("",!0),d.value==="Finished"?(o(),y(v,{key:2,style:{color:"#52c41a"}})):b("",!0),d.value==="Created"?(o(),y(l,{key:3,style:{color:"#333"}})):b("",!0),u("span",Ue,k(c.$t(d.value)),1)],4),m.value?(o(),p("div",Ke,k(c.$t("noResult")),1)):(o(),p("div",Pe,[u("table",je,[u("thead",We,[u("tr",null,[(o(!0),p(R,null,M(n.info.columns,h=>(o(),p("th",{key:h},k(h),1))),128))])]),u("tbody",Ye,[(o(!0),p(R,null,M(n.info.rowData,(h,S)=>(o(),p("tr",{key:S+1},[(o(!0),p(R,null,M(h,(s,r)=>(o(),p("td",{key:`${S}${s}${r}`},[u("span",{class:"td-val",title:s||""},k(s),9,Ge)]))),128))]))),128))])])]))])}}}),Qe=A(Je,[["__scopeId","data-v-0b3df6bc"]]),Xe={class:"sql-log"},Ze=["innerHTML"],xe=N({__name:"sql-log",setup(e,{expose:n}){const m=f("");return n({initData(d){m.value=d}}),(d,c)=>(o(),p("div",Xe,[u("div",{style:{"white-space":"pre-wrap","font-size":"12px"},innerHTML:m.value},null,8,Ze)]))}}),et=A(xe,[["__scopeId","data-v-1f3c255d"]]);function tt(e){return I.get(`ams/v1/terminal/${e}/result`)}function nt(){return I.get("ams/v1/terminal/examples")}function st(e){return I.get(`ams/v1/terminal/examples/${e}`)}function ot(e){const{catalog:n,sql:m}=e;return I.post(`ams/v1/terminal/catalogs/${n}/execute`,{sql:m})}function at(e){return I.put(`ams/v1/terminal/${e}/stop`)}function lt(e){return I.get(`ams/v1/terminal/${e}/logs`)}function ut(){return I.get("ams/v1/terminal/latestInfos")}const it=N({name:"Terminal",components:{SqlEditor:ce,SqlResult:Qe,SqlLog:et},setup(){const e=F(Be()),n=f(!1),m=f(null),d=f(null),c=f(!1),a=f(""),_=f(!1),l=f(""),v=f(),h=f(!1),S=f(!1),s=f("log"),r=F([]),C=F([]),O=f(""),w=f(),$=F([]),i=f(476),z=Oe(le),Y="easylake-sql-source",G="easylake-use-catalog";se(()=>c,()=>{m.value.updateOptions({readOnly:c})});function de(t){if(t==="debug"){he();return}if(t==="format"){m.value&&m.value.executeCommand("format");return}t==="pause"&&ye()}async function ge(){if((await Fe()||[]).forEach(g=>{r.push({value:g.catalogName,label:g.catalogName})}),r.length){const g=ee(G),L=r.findIndex(P=>P.value===g);O.value=L>-1?g:r[0].value}}async function pe(){const t=await nt();C.push(...t||[])}function me(){x(G,O.value)}function ve(){h.value=!h.value}function fe(){S.value=!S.value}function U(){$.length=0,d.value.initData("")}async function he(){try{if(!O.value){B.error(e.selectClPh);return}_.value=!0,U(),l.value="Running";const t=m.value.getSelection()||a.value,g=await ot({catalog:O.value,sql:t});v.value=g.sessionId||"0",K()}catch(t){l.value="Failed",B.error(t.message||"error")}}async function ye(){v.value&&(s.value="log",w.value&&clearTimeout(w.value),_.value=!1,l.value="Canceling",U(),c.value=!0,await at(v.value).then(()=>{l.value="Canceled"}).catch(()=>{l.value="Failed"}).finally(()=>{c.value=!1}))}const _e=async()=>{try{$.length=0;const t=await tt(v.value||"0");t&&t.length&&$.push(...t)}catch{}};async function K(){if(w.value&&clearTimeout(w.value),l.value==="Running"&&v.value){const t=await lt(v.value);s.value="log";const{logStatus:g,logs:L}=t||{};if(L!=null&&L.length&&d.value.initData(L.join(`
`)),l.value!=="Canceled"&&(l.value=g),await _e(),g==="Finished"||g==="Canceled")$.length&&(s.value=$[0].id);else{if(l.value==="Canceled")return;w.value=setTimeout(()=>{K()},1500)}}}const Ce=async t=>{try{if(s.value="log",l.value==="Running")return;clearTimeout(w.value),n.value=!0;const g=await st(t);a.value=`${a.value}
-- SQL shortcut generated
${g}`,_.value=!1,l.value="",U()}catch(g){B.error(g.message)}finally{n.value=!1}},be=()=>document.body,Se=async()=>{try{m.value&&(a.value=ee(Y)),n.value=!0;const t=await ut();v.value=t.sessionId,t.sessionId>"0"&&(m.value&&!a.value&&(a.value=t.sql||""),l.value="Running",_.value=!0,K())}catch(t){B.error(t.message)}finally{n.value=!1}},T={topbarHeight:48,optionHeight:44,resultTabHeight:40,runStatusHeight:32,gap:48};let J=0,Q=0;function qe(t){J=t.clientY,Q=i.value,window.addEventListener("mousemove",X),window.addEventListener("mouseup",Z)}function X(t){const L=t.clientY-J,P=h.value?0:T.topbarHeight,ke=l.value?T.runStatusHeight:0;let D=Q+L;D=Math.max(D,T.optionHeight+ke),D=Math.min(D,window.innerHeight-P-(h.value?0:T.gap)-T.optionHeight-4),i.value=D}function Z(){window.removeEventListener("mousemove",X),window.removeEventListener("mouseup",Z)}function x(t,g){localStorage.setItem(t,g)}function ee(t){return localStorage.getItem(t)||""}return oe(()=>{clearTimeout(w.value),x(Y,a.value)}),ae(()=>{Se(),pe(),ge()}),{loading:n,bgcMap:z,sqlLogRef:d,sqlEditorRef:m,fullscreen:h,resultFullscreen:S,operationActive:s,resultTabList:$,runStatus:l,shortcuts:C,curCatalog:O,catalogOptions:r,handleIconClick:de,handleFull:ve,resultFull:fe,showDebug:_,sqlSource:a,readOnly:c,generateCode:Ce,getPopupContainer:be,sqlResultHeight:i,dragMounseDown:qe,changeUseCatalog:me}}}),rt={class:"console-wrap"},ct={class:"sql-block"},dt={class:"top-ops g-flex-jsb"},gt={class:"title-left g-flex-ac"},pt={class:"select-catalog g-mr-12"},mt={class:"label"},vt={class:"title-right"},ft={class:"sql-content"},ht={class:"sql-raw"},yt={class:"sql-shortcuts"},_t={class:"shortcuts"},Ct={class:"g-ml-12"},bt={class:"tab-operation"},St={class:"tab"},qt=["onClick"],kt={class:"debug-result"};function wt(e,n,m,d,c,a){const _=De,l=Te,v=He,h=ce,S=Ee,s=ue,r=ie,C=re,O=W("SqlLog"),w=W("SqlResult"),$=W("u-loading");return o(),p("div",rt,[u("div",{class:E(["console-content",{fullscreen:e.fullscreen}])},[u("div",{style:V({height:`${e.sqlResultHeight}px`}),class:"sql-wrap"},[u("div",ct,[u("div",dt,[u("div",gt,[u("div",pt,[u("span",mt,k(e.$t("use")),1),q(_,{value:e.curCatalog,"onUpdate:value":n[0]||(n[0]=i=>e.curCatalog=i),style:{width:"200px"},options:e.catalogOptions,onChange:e.changeUseCatalog},null,8,["value","options","onChange"])]),e.runStatus==="Running"?(o(),y(v,{key:0,title:e.$t("pause"),placement:"bottom"},{default:H(()=>[q(l,{"class-name":"icon-svg","icon-class":"sqlpause",class:"g-mr-12",disabled:e.readOnly,onClick:n[1]||(n[1]=i=>e.handleIconClick("pause"))},null,8,["disabled"])]),_:1},8,["title"])):(o(),y(v,{key:1,title:e.$t("run"),placement:"bottom"},{default:H(()=>[q(l,{"class-name":"icon-svg","icon-class":"sqldebug",class:"g-mr-12",disabled:e.readOnly,onClick:n[2]||(n[2]=i=>e.handleIconClick("debug"))},null,8,["disabled"])]),_:1},8,["title"])),q(v,{title:e.$t("format"),placement:"bottom"},{default:H(()=>[q(l,{"class-name":"icon-svg","is-stroke":!0,"icon-class":"format",disabled:e.readOnly,onClick:n[3]||(n[3]=i=>e.handleIconClick("format"))},null,8,["disabled"])]),_:1},8,["title"])]),u("div",vt,[q(v,{title:e.fullscreen?e.$t("recovery"):e.$t("fullscreen"),placement:"bottom","get-popup-container":e.getPopupContainer},{default:H(()=>[q(l,{"class-name":"icon-svg","is-stroke":!0,"icon-class":e.fullscreen?"sqlinit":"sqlmax",disabled:!1,class:"g-ml-12",onClick:e.handleFull},null,8,["icon-class","onClick"])]),_:1},8,["title","get-popup-container"])])]),u("div",ft,[u("div",ht,[q(h,{ref:"sqlEditorRef",value:e.sqlSource,"onUpdate:value":n[4]||(n[4]=i=>e.sqlSource=i),"sql-value":e.sqlSource,"read-only":e.readOnly,options:{readOnly:e.readOnly,minimap:{enabled:!1}}},null,8,["value","sql-value","read-only","options"])])])]),u("div",yt,[u("div",_t,k(e.$t("sqlShortcuts")),1),(o(!0),p(R,null,M(e.shortcuts,i=>(o(),y(S,{key:i,type:"link",disabled:e.runStatus==="Running"||e.runStatus==="Canceling",class:"code",onClick:z=>e.generateCode(i)},{default:H(()=>[Me(k(i),1)]),_:2},1032,["disabled","onClick"]))),128))])],4),e.runStatus?(o(),p("div",{key:0,class:"run-status",style:V({background:e.bgcMap[e.runStatus]})},[e.runStatus==="Running"||e.runStatus==="Canceling"?(o(),y(s,{key:0,style:{color:"#1890ff"}})):b("",!0),e.runStatus==="Canceled"||e.runStatus==="Failed"?(o(),y(r,{key:1,style:{color:"#ff4d4f"}})):b("",!0),e.runStatus==="Finished"?(o(),y(C,{key:2,style:{color:"#52c41a"}})):b("",!0),e.runStatus==="Created"?(o(),y(r,{key:3,style:{color:"#333"}})):b("",!0),u("span",Ct,k(e.$t(e.runStatus)),1)],4)):b("",!0),u("div",{class:E(["sql-result",e.resultFullscreen?"result-full":""]),style:V({height:`calc(100% - ${e.sqlResultHeight}px)`})},[u("span",{class:"drag-line",onMousedown:n[5]||(n[5]=(...i)=>e.dragMounseDown&&e.dragMounseDown(...i))},[q(l,{class:"icon","icon-class":"slide"})],32),u("div",bt,[u("div",St,[u("span",{class:E([{active:e.operationActive==="log"},"tab-item"]),onClick:n[6]||(n[6]=i=>e.operationActive="log")},k(e.$t("log")),3),(o(!0),p(R,null,M(e.resultTabList,i=>(o(),p("span",{key:i.id,class:E([{active:e.operationActive===i.id},"tab-item"]),onClick:z=>e.operationActive=i.id},k(i.id),11,qt))),128))])]),u("div",kt,[Re(q(O,{ref:"sqlLogRef"},null,512),[[Ie,e.operationActive==="log"]]),(o(!0),p(R,null,M(e.resultTabList,i=>(o(),p(R,{key:i.id},[e.operationActive===i.id?(o(),y(w,{key:0,info:i},null,8,["info"])):b("",!0)],64))),128))])],6)],2),e.loading?(o(),y($,{key:0})):b("",!0)])}const Bt=A(it,[["render",wt],["__scopeId","data-v-32f5d70c"]]);export{Bt as default};
