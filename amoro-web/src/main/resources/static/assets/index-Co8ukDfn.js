
/*
  * Licensed to the Apache Software Foundation (ASF) under one
  * or more contributor license agreements.  See the NOTICE file
  * distributed with this work for additional information
  * regarding copyright ownership.  The ASF licenses this file
  * to you under the Apache License, Version 2.0 (the
  * "License"); you may not use this file except in compliance
  * with the License.  You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */

import{d as W,U as Y,a7 as se,ae as F,f as I,r as R,o as X,W as V,X as v,a0 as D,a3 as M,k as r,Y as h,u as N,V as j,a2 as O,F as J,a6 as L,af as re,a1 as A,G as ue,c as ne,a8 as _e,w as ve,I as be}from"./vue-KZ6HWXOH.js";import{g as ce,a as he,r as pe,s as ye,b as Ge,c as ze,d as Ie,e as ke,u as Ce,f as $e,_ as we}from"./optimize.service-CzrEuJsb.js";import{u as ee}from"./usePagination-flyrWnsD.js";import{u as H}from"./usePlaceholder-DDdrf-Dx.js";import{f as Se,h as Te,c as Re,_ as te,m as ie,b as le}from"./index-C3lMfZSI.js";import{W as Oe,p as de,M as U,b as me,I as ae,c as fe,F as ge,a as Z,v as Le,u as Me,B as De}from"./antd-CPSoav-4.js";import"./pinia-BCc-Ghqu.js";import"./dayjs-DZyl58SH.js";import"./monaco-DM8nFf3H.js";import"./sql-BwF-LpWF.js";import"./axios-B4uVmeYG.js";const Ne={class:"list-wrap"},xe=["title","onClick"],Pe=["title"],qe=["onClick"],Ee=W({__name:"List",setup(a){const{t:o}=Y(),b=se(),C=F({pending:{title:"pending",color:"#ffcc00"},planning:{title:"planning",color:"#076de3"},idle:{title:"idle",color:"#c9cdd4"},minor:{title:"minor",color:"#0ad787"},major:{title:"major",color:"#0ad787"},full:{title:"full",color:"#0ad787"},committing:{title:"committing",color:"#0ad787"}}),e=I(!1),y=I(!1),s=I([]),u=F([{dataIndex:"tableName",title:o("table"),ellipsis:!0,scopedSlots:{customRender:"tableName"}},{dataIndex:"groupName",title:o("optimizerGroup"),width:"16%",ellipsis:!0},{dataIndex:"optimizeStatus",title:o("optimizingStatus"),width:"16%",ellipsis:!0},{dataIndex:"durationDisplay",title:o("duration"),width:"10%",ellipsis:!0},{dataIndex:"fileCount",title:o("fileCount"),width:"10%",ellipsis:!0},{dataIndex:"fileSizeDesc",title:o("fileSize"),width:"10%",ellipsis:!0},{dataIndex:"quota",title:o("quota"),width:"10%",ellipsis:!0},{dataIndex:"quotaOccupationDesc",title:o("occupation"),width:120,ellipsis:!0}]),t=R(ee()),m=R([]),n=I(),G=I(),f=I(),x=R(H());async function c(){const _=(await ce()||[]).map($=>({lable:$.resourceGroup.name,value:$.resourceGroup.name}));s.value=_}function i(g){g&&(t.current=1),S()}async function S(){try{m.length=0,e.value=!0;const g={optimizerGroup:n.value||"all",dbSearchInput:G.value||"",tableSearchInput:f.value||"",page:t.current,pageSize:t.pageSize},_=await he(g),{list:$,total:q}=_;t.total=q,($||[]).forEach(k=>{k.quotaOccupationDesc=k.quotaOccupation-5e-4>0?`${(k.quotaOccupation*100).toFixed(1)}%`:"0",k.durationDesc=k.duration?Se(k.duration):"-",k.durationDisplay=Te(k.duration||0),k.fileSizeDesc=Re(k.fileSize),m.push(k)})}catch{}finally{e.value=!1}}function P(g){g.container!=="external"&&U.confirm({title:o("releaseOptModalTitle"),onOk:()=>{B(g)}})}async function B(g){try{y.value=!0,await pe({optimizerGroup:g.groupName,jobId:g.jobId}),i(!0)}finally{y.value=!1}}function K({current:g=t.current,pageSize:_=t.pageSize}){t.current=g;const $=_!==t.pageSize;t.pageSize=_,i($)}function E(g){const{catalog:_,database:$,tableName:q}=g.tableIdentifier;b.push({path:"/tables",query:{catalog:_,db:$,table:q}})}return X(()=>{i(),c()}),(g,_)=>{const $=me,q=ae,k=Oe,l=de,d=V("u-loading");return v(),D(J,null,[M("div",Ne,[r(k,{class:"filter-form"},{default:h(()=>[r($,{value:n.value,"onUpdate:value":_[0]||(_[0]=z=>n.value=z),"allow-clear":"",placeholder:"Optimizer group",options:s.value,style:{"min-width":"150px"},onChange:i},null,8,["value","options"]),r(q,{value:G.value,"onUpdate:value":_[1]||(_[1]=z=>G.value=z),placeholder:x.filterDBPh,onChange:i},null,8,["value","placeholder"]),r(q,{value:f.value,"onUpdate:value":_[2]||(_[2]=z=>f.value=z),placeholder:x.filterTablePh,onChange:i},null,8,["value","placeholder"])]),_:1}),r(l,{class:"ant-table-common",columns:N(u),"data-source":m,pagination:t,loading:e.value,onChange:K},{bodyCell:h(({column:z,record:T})=>{var p;return[z.dataIndex==="tableName"?(v(),D("span",{key:0,title:T.tableName,class:"primary-link",onClick:w=>E(T)},L(T.tableName),9,xe)):O("",!0),z.dataIndex==="durationDisplay"?(v(),D("span",{key:1,title:T.durationDesc},L(T.durationDisplay),9,Pe)):O("",!0),z.dataIndex==="optimizeStatus"?(v(),D(J,{key:2},[M("span",{style:re({"background-color":(p=N(C)[T.optimizeStatus])==null?void 0:p.color}),class:"status-icon"},null,4),M("span",null,L(T.optimizeStatus),1)],64)):O("",!0),z.dataIndex==="operation"?(v(),D("span",{key:3,class:A(["primary-link",{disabled:T.container==="external"}]),onClick:w=>P(T)},L(N(o)("release")),11,qe)):O("",!0)]}),_:1},8,["columns","data-source","pagination","loading"])]),y.value?(v(),j(d,{key:0})):O("",!0)],64)}}}),je=te(Ee,[["__scopeId","data-v-745db798"]]),Fe=W({__name:"ScaleOut",props:{groupRecord:{}},emits:["cancel","refresh"],setup(a,{emit:o}){var n;const b=a,C=o,e=I(!1),y=R(H()),s=I(),u=R({resourceGroup:((n=b.groupRecord)==null?void 0:n.name)||"",parallelism:1});function t(){s.value.validateFields().then(async()=>{e.value=!0,await ye({optimizerGroup:u.resourceGroup||"",parallelism:Number(u.parallelism)}),s.value.resetFields(),C("cancel"),C("refresh"),e.value=!1}).catch(()=>{e.value=!1})}function m(){s.value.resetFields(),C("cancel")}return X(()=>{}),(G,f)=>{const x=fe,c=ae,i=ge;return v(),j(N(U),{open:!0,title:G.$t("scaleOut"),"confirm-loading":e.value,closable:!1,onOk:t,onCancel:m},{default:h(()=>[r(i,{ref_key:"formRef",ref:s,model:u,class:"label-120"},{default:h(()=>[r(x,{name:"resourceGroup",label:G.$t("resourceGroup")},{default:h(()=>[ue(L(u.resourceGroup),1)]),_:1},8,["label"]),r(x,{name:"parallelism",label:G.$t("parallelism"),rules:[{required:!0,message:`${y.parallelismPh}`}]},{default:h(()=>[r(c,{value:u.parallelism,"onUpdate:value":f[0]||(f[0]=S=>u.parallelism=S),type:"number",placeholder:y.parallelismPh},null,8,["value","placeholder"])]),_:1},8,["label","rules"])]),_:1},8,["model"])]),_:1},8,["title","confirm-loading"])}}}),Ae={class:"list-wrap"},Ue=["title"],Be=["onClick"],Ke=["onClick"],Ve=["onClick"],Je=["onClick"],We=W({__name:"List",props:{curGroupName:{},type:{}},emits:["editGroup","refresh","refreshCurGroupInfo"],setup(a,{emit:o}){const b=a,C=o,{t:e}=Y(),y=F({pending:{title:"pending",color:"#ffcc00"},planning:{title:"planning",color:"#076de3"},idle:{title:"idle",color:"#c9cdd4"},minor:{title:"minor",color:"#0ad787"},major:{title:"major",color:"#0ad787"},full:{title:"full",color:"#0ad787"},committing:{title:"committing",color:"#0ad787"}}),s=I(!1),u=I(!1),t=F([{dataIndex:"name",title:e("name"),ellipsis:!0},{dataIndex:"container",title:e("container"),width:"23%",ellipsis:!0},{dataIndex:"resourceOccupation",title:e("resourceOccupation"),width:"23%",ellipsis:!0},{dataIndex:"operationGroup",title:e("operation"),key:"operationGroup",ellipsis:!0,width:230,scopedSlots:{customRender:"operationGroup"}}]),m=F([{dataIndex:"jobId",title:e("optimizerId"),width:"15%",ellipsis:!0},{dataIndex:"token",title:e("token"),width:"10%",ellipsis:!0},{dataIndex:"groupName",title:e("optimizerGroup"),ellipsis:!0},{dataIndex:"container",title:e("container"),ellipsis:!0},{dataIndex:"jobStatus",title:e("status"),ellipsis:!0},{dataIndex:"resourceAllocation",title:e("resourceAllocation"),width:"10%",ellipsis:!0},{dataIndex:"startTime",title:e("startTime"),width:172,ellipsis:!0},{dataIndex:"touchTime",title:e("touchTime"),width:172,ellipsis:!0},{dataIndex:"operation",title:e("operation"),key:"operation",ellipsis:!0,width:160,scopedSlots:{customRender:"operationGroup"}}]),n=R(ee()),G=R([]),f=R([]),x=ne(()=>b.type==="optimizers"?m:t),c=ne(()=>b.type==="optimizers"?G:f);function i(l){l&&(n.current=1),b.type==="optimizers"?B():K()}function S(l){l.container!=="external"&&U.confirm({title:e("releaseOptModalTitle"),onOk:()=>{P(l)}})}async function P(l){try{u.value=!0,await pe({optimizerGroup:l.groupName,jobId:l.jobId}),i(!0),C("refreshCurGroupInfo")}finally{u.value=!1}}async function B(){try{G.length=0,s.value=!0;const l={optimizerGroup:"all",page:n.current,pageSize:n.pageSize},d=await Ge(l),{list:z,total:T}=d;n.total=T,(z||[]).forEach((p,w)=>{p.resourceAllocation=`${p.coreNumber} ${e("core")} ${ie(p.memory)}`,p.index=(n.current-1)*n.pageSize+w+1,p.startTime=p.startTime?le(p.startTime):"-",p.touchTime=p.touchTime?le(p.touchTime):"-",G.push(p)})}catch{}finally{s.value=!1}}async function K(){try{f.length=0,s.value=!0;const l=await ce();n.total=l.length,(l||[]).forEach(d=>{d.name=d.resourceGroup.name,d.container=d.resourceGroup.container,d.resourceOccupation=`${d.occupationCore} ${e("core")} ${ie(d.occupationMemory)}`,f.push(d)})}catch{}finally{s.value=!1}}function E(l){C("editGroup",l)}async function g(l){if(await ze({name:l.name})){U.confirm({title:e("deleteGroupModalTitle"),onOk:async()=>{await Ie({name:l.name}),Z.success(`${e("remove")} ${e("success")}`),i()}});return}U.warning({title:e("cannotDeleteGroupModalTitle"),content:e("cannotDeleteGroupModalContent")})}const _=I({resourceGroup:{name:"",container:"",properties:{}},occupationCore:0,occupationMemory:0,name:"",container:"",resourceOccupation:""}),$=I(!1);function q(l){l.container!=="external"&&(_.value={...l},$.value=!0)}function k({current:l=n.current,pageSize:d=n.pageSize}){n.current=l;const z=d!==n.pageSize;n.pageSize=d,i(z)}return X(()=>{i()}),(l,d)=>{const z=de,T=V("u-loading");return v(),D(J,null,[M("div",Ae,[r(z,{class:"ant-table-common",columns:x.value,"data-source":c.value,pagination:n,loading:s.value,onChange:k},{bodyCell:h(({column:p,record:w})=>{var oe;return[p.dataIndex==="durationDisplay"?(v(),D("span",{key:0,title:w.durationDesc},L(w.durationDisplay),9,Ue)):O("",!0),p.dataIndex==="optimizeStatus"?(v(),D(J,{key:1},[M("span",{style:re({"background-color":(oe=N(y)[w.optimizeStatus])==null?void 0:oe.color}),class:"status-icon"},null,4),M("span",null,L(w.optimizeStatus),1)],64)):O("",!0),p.dataIndex==="operation"?(v(),D("span",{key:2,class:A(["primary-link",{disabled:w.container==="external"}]),onClick:Q=>S(w)},L(N(e)("release")),11,Be)):O("",!0),p.dataIndex==="operationGroup"?(v(),D(J,{key:3},[M("span",{class:A(["primary-link g-mr-12",{disabled:w.container==="external"}]),onClick:Q=>q(w)},L(N(e)("scaleOut")),11,Ke),M("span",{class:"primary-link g-mr-12",onClick:Q=>E(w)},L(N(e)("edit")),9,Ve),M("span",{class:"primary-link",onClick:Q=>g(w)},L(N(e)("remove")),9,Je)],64)):O("",!0)]}),_:1},8,["columns","data-source","pagination","loading"])]),$.value?(v(),j(Fe,{key:0,"group-record":_.value,onCancel:d[0]||(d[0]=p=>$.value=!1),onRefresh:i},null,8,["group-record"])):O("",!0),u.value?(v(),j(T,{key:1})):O("",!0)],64)}}}),Xe=te(We,[["__scopeId","data-v-13850edc"]]),Ye=W({__name:"GroupModal",props:{edit:{type:Boolean},editRecord:{}},emits:["cancel","refresh"],setup(a,{emit:o}){const b=a,C=o,{t:e}=Y(),y=R(H()),s=I({containerList:[]});async function u(){const i=(await ke()||[]).map(S=>({label:S,value:S}));s.value.containerList=i}const t=R({name:"",container:void 0,properties:{}}),m=I(!1);function n(){C("cancel")}const G=I(),f=I();function x(){G.value.validateFields().then(async()=>{try{const c=await f.value.getProperties(),i={name:t.name,container:t.container,properties:c};b.edit?await Ce(i):await $e(i),Z.success(`${e("save")} ${e("success")}`),C("refresh")}catch{Z.error(`${e("save")} ${e("failed")}`)}})}return X(()=>{var c,i,S;u(),b.edit&&(t.name=(c=b.editRecord)==null?void 0:c.name,t.container=(i=b.editRecord)==null?void 0:i.container,t.properties=(S=b.editRecord)==null?void 0:S.resourceGroup.properties)}),(c,i)=>{const S=ae,P=fe,B=me,K=ge;return v(),j(N(U),{open:!0,title:c.edit?c.$t("editgroup"):c.$t("addgroup"),"confirm-loading":m.value,closable:!1,class:"group-modal",onOk:x,onCancel:n},{default:h(()=>[r(K,{ref_key:"formRef",ref:G,model:t,class:"label-120"},{default:h(()=>[r(P,{name:"name",label:c.$t("name"),rules:[{required:!0,message:`${y.groupNamePh}`}]},{default:h(()=>[r(S,{value:t.name,"onUpdate:value":i[0]||(i[0]=E=>t.name=E),placeholder:y.groupNamePh,disabled:c.edit},null,8,["value","placeholder","disabled"])]),_:1},8,["label","rules"]),r(P,{name:"container",label:c.$t("container"),rules:[{required:!0,message:`${y.groupContainer}`}]},{default:h(()=>[r(B,{value:t.container,"onUpdate:value":i[1]||(i[1]=E=>t.container=E),"show-search":!0,options:s.value.containerList,placeholder:y.groupContainer},null,8,["value","options","placeholder"])]),_:1},8,["label","rules"]),r(P,{label:c.$t("properties")},null,8,["label"]),r(P,null,{default:h(()=>[r(we,{ref_key:"propertiesRef",ref:f,"properties-obj":t.properties,"is-edit":!0},null,8,["properties-obj"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","confirm-loading"])}}}),He=W({name:"Resource",components:{List:Xe,GroupModal:Ye,TableList:je},setup(){const{t:a}=Y(),o=se(),b=_e(),C=F([{label:a("optimizergroup"),value:"optimizergroup"},{label:a("optimizers"),value:"optimizers"}]),e=R(H()),y=R(ee()),s=R({activeTab:"optimizergroup",showGroupModal:!1,groupEdit:!1,groupEditRecord:{resourceGroup:{name:"",container:"",properties:{}},occupationCore:0,occupationMemory:0,name:"",container:"",resourceOccupation:""},groupKeyCount:1,showTab:!1});ve(()=>b.query,m=>{s.activeTab=m.tab||"tables"},{immediate:!0});const u=m=>{m?(s.groupEdit=!0,s.groupEditRecord={...m}):s.groupEdit=!1,s.showGroupModal=!0},t=m=>{const n={...b.query};n.tab=m,o.replace({query:{...n}})};return X(()=>{s.showTab=!0}),{placeholder:e,pagination:y,...be(s),tabConfig:C,onChangeTab:t,editGroup:u,t:a}}}),Qe={class:"border-wrap"},Ze={class:"resource-wrap"},et={class:"content"};function tt(a,o,b,C,e,y){const s=V("TableList"),u=Me,t=V("List"),m=De,n=Le,G=V("GroupModal");return v(),D("div",Qe,[M("div",Ze,[M("div",et,[r(n,{activeKey:a.activeTab,"onUpdate:activeKey":o[1]||(o[1]=f=>a.activeTab=f),"destroy-inactive-tab-pane":"",onChange:a.onChangeTab},{default:h(()=>[r(u,{key:"tables",tab:a.t("tables"),class:A([a.activeTab==="tables"?"active":""])},{default:h(()=>[r(s)]),_:1},8,["tab","class"]),r(u,{key:"optimizers",tab:a.t("optimizers"),class:A([a.activeTab==="optimizers"?"active":""])},{default:h(()=>[r(t,{type:"optimizers"})]),_:1},8,["tab","class"]),r(u,{key:"optimizergroup",tab:a.t("optimizergroup"),class:A([a.activeTab==="optimizergroup"?"active":""])},{default:h(()=>[r(m,{type:"primary",class:"g-mb-16",onClick:o[0]||(o[0]=f=>a.editGroup(null))},{default:h(()=>[ue(L(a.t("addgroup")),1)]),_:1}),(v(),j(t,{key:a.groupKeyCount,type:"optimizergroup",onEditGroup:a.editGroup},null,8,["onEditGroup"]))]),_:1},8,["tab","class"])]),_:1},8,["activeKey","onChange"])])]),a.showGroupModal?(v(),j(G,{key:0,edit:a.groupEdit,"edit-record":a.groupEditRecord,onCancel:o[2]||(o[2]=f=>a.showGroupModal=!1),onRefresh:o[3]||(o[3]=f=>{a.groupKeyCount++,a.showGroupModal=!1})},null,8,["edit","edit-record"])):O("",!0)])}const mt=te(He,[["render",tt],["__scopeId","data-v-0b7fcc01"]]);export{mt as default};
