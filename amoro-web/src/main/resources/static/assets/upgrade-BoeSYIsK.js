
/*
  * Licensed to the Apache Software Foundation (ASF) under one
  * or more contributor license agreements.  See the NOTICE file
  * distributed with this work for additional information
  * regarding copyright ownership.  The ASF licenses this file
  * to you under the Apache License, Version 2.0 (the
  * "License"); you may not use this file except in compliance
  * with the License.  You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */

import{d as U,U as N,ae as S,X as $,a0 as x,k as o,Y as u,V as M,a2 as X,u as T,r as y,f as j,w as Y,o as q,a3 as g,a6 as O,F as z,aa as J,G as L,a8 as Q,c as W}from"./vue-KZ6HWXOH.js";import{m as Z,p as H,E as ee,c as K,I as te,G as ae,F as D,B as A,H as oe}from"./antd-CPSoav-4.js";import{r as se,q as ne,u as le}from"./table.service-CoshcICY.js";import{e as V,_ as ie}from"./index-C3lMfZSI.js";import{u as re}from"./usePlaceholder-DDdrf-Dx.js";import"./dayjs-DZyl58SH.js";import"./pinia-BCc-Ghqu.js";import"./monaco-DM8nFf3H.js";import"./sql-BwF-LpWF.js";import"./axios-B4uVmeYG.js";const ce={class:"field-wrap"},pe=U({__name:"Field",props:{fields:{},loading:{type:Boolean}},setup(C,{expose:b}){const r=C,{t:n}=N(),d=S([{dataIndex:"field",title:n("field"),ellipsis:!0},{dataIndex:"type",title:n("type"),ellipsis:!0},{dataIndex:"comment",title:n("description"),ellipsis:!0},{dataIndex:"primaryKey",title:n("primaryKey"),scopedSlots:{customRender:"primaryKey"}}]);return b({getPkname(){return r.fields.filter(i=>i.checked).map(i=>({fieldName:i.field||""}))}}),(i,m)=>{const l=Z,F=H;return $(),x("div",ce,[o(F,{loading:i.loading,class:"ant-table-common",columns:T(d),"data-source":r.fields,pagination:!1},{bodyCell:u(({column:h,record:k})=>[h.dataIndex==="primaryKey"?($(),M(l,{key:0,checked:k.checked,"onUpdate:checked":P=>k.checked=P},null,8,["checked","onUpdate:checked"])):X("",!0)]),_:1},8,["loading","columns","data-source"])])}}}),ue={class:"partition-field-wrap"},de=U({__name:"Partition",props:{partitionFields:{},loading:{type:Boolean}},setup(C){const b=C,{t:r}=N(),n=S([{dataIndex:"field",title:r("field"),ellipsis:!0},{dataIndex:"type",title:r("type"),ellipsis:!0},{dataIndex:"comment",title:r("description"),ellipsis:!0}]);return(d,i)=>{const m=H;return $(),x("div",ue,[o(m,{loading:d.loading,class:"ant-table-common",columns:T(n),"data-source":b.partitionFields,pagination:!1},null,8,["loading","columns","data-source"])])}}}),_e={class:"config-properties"},fe={class:"config-header g-flex"},me={class:"td g-flex-ac"},ge={class:"td g-flex-ac bd-left"},he=U({__name:"Properties",props:{propertiesObj:{}},setup(C,{expose:b}){const r=C,n=y([]),d=j(),i=y([]),m=j(),l=y({data:[]}),F=y(re());Y(()=>r.propertiesObj,()=>{h()},{immediate:!0,deep:!0});function h(){n.length=0,l.data.length=0,Object.keys(r.propertiesObj).forEach(t=>{l.data.push({key:t,value:r.propertiesObj[t],uuid:V()})})}async function k(){i.length=0,d.value=[];const t=await se();Object.keys(t).forEach(a=>{var e;const v={key:a,label:a,value:a,text:t[a]||""};i.push(v),(e=d.value)==null||e.push(v)})}function P(t,a){return a.key.toUpperCase().includes(t.toUpperCase())}function B(t,a,v){const e=a.key,s=i.find(f=>f.key===e),_=l.data.find(f=>f.uuid===v.uuid);_&&(_.value=(s==null?void 0:s.value)||"",_.key=(s==null?void 0:s.key)||"")}function R(t){const a=l.data.indexOf(t);a!==-1&&l.data.splice(a,1)}function E(){l.data.push({key:"",value:"",uuid:V()})}return b({getProperties(){return m.value.validateFields().then(()=>{const t={};return l.data.forEach(a=>{t[a.key]=a.value}),Promise.resolve(t)}).catch(()=>!1)}}),q(()=>{k()}),(t,a)=>{const v=ee,e=K,s=te,_=ae,f=D,I=A;return $(),x("div",_e,[g("div",fe,[g("div",me,O(t.$t("key")),1),g("div",ge,O(t.$t("value")),1)]),o(f,{ref_key:"propertiesFormRef",ref:m,model:l,class:"g-mt-12"},{default:u(()=>[($(!0),x(z,null,J(l.data,(c,w)=>($(),x("div",{key:c.uuid,class:"config-row"},[o(e,{name:["data",w,"key"],rules:[{required:!0,message:`${t.$t(F.selectPh)}`}],class:"g-mr-8"},{default:u(()=>[o(v,{value:c.key,"onUpdate:value":p=>c.key=p,options:d.value,"filter-option":P,style:{width:"100%"},class:"g-mr-12",onSelect:(p,G)=>B(p,G,c)},{option:u(({key:p})=>[g("span",null,O(p),1)]),_:2},1032,["value","onUpdate:value","options","onSelect"])]),_:2},1032,["name","rules"]),o(e,{name:["data",w,"value"],rules:[{required:!0,message:`${t.$t(F.inputPh)}`}]},{default:u(()=>[o(s,{value:c.value,"onUpdate:value":p=>c.value=p,maxlength:64,style:{width:"100%"}},null,8,["value","onUpdate:value"])]),_:2},1032,["name","rules"]),o(_,{class:"icon-close",onClick:p=>R(c)},null,8,["onClick"])]))),128))]),_:1},8,["model"]),o(I,{class:"config-btn",onClick:E},{default:u(()=>[L(" + ")]),_:1})])}}}),ve={class:"upgrade-table"},ye={class:"nav-bar"},be={class:"title g-ml-8"},ke={class:"content"},$e={class:"table-attrs"},Ce={class:"footer-btn"},Fe=U({__name:"upgrade",emits:["goBack","refresh"],setup(C,{emit:b}){const r=b,n=j(!1),d=y([]),i=y([]),m=y({}),l=y([]),F=Q(),h=W(()=>({...F.query})),k=j(),P=j();async function B(){try{const{catalog:e,db:s,table:_}=h.value;if(!e||!s||!_)return;n.value=!0,i.length=0,d.length=0;const f=await ne({...h.value}),{partitionColumnList:I=[],schema:c,properties:w}=f;(I||[]).forEach(p=>{i.push(p)}),(c||[]).forEach(p=>{d.push(p)}),Object.assign(m,w)}catch{}finally{n.value=!1}}function R(){E()}async function E(){l.length=0,k.value.getPkname().forEach(s=>l.push(s)),P.value.getProperties().then(s=>{s&&(Object.assign(m,s),t())})}async function t(){try{const{catalog:e,db:s,table:_}=h.value;if(!e||!s||!_)return;n.value=!0,await le({...h.value,pkList:l,properties:m}),a(),r("refresh")}catch{a()}finally{n.value=!1}}function a(){r("goBack")}function v(){a()}return q(()=>{B()}),(e,s)=>{const _=oe,f=K,I=D,c=A;return $(),x("div",ve,[g("div",ye,[o(_,{onClick:a}),g("span",be,O(e.$t("upgradeHiveTable")),1)]),g("div",ke,[g("div",$e,[o(I,{name:"fields",class:"label-120"},{default:u(()=>[o(f,{label:e.$t("field"),name:"field"},{default:u(()=>[o(pe,{ref_key:"schemaFieldRef",ref:k,loading:n.value,fields:d},null,8,["loading","fields"])]),_:1},8,["label"]),o(f,{label:e.$t("partitonField"),name:"partitonField"},{default:u(()=>[o(de,{loading:n.value,"partition-fields":i},null,8,["loading","partition-fields"])]),_:1},8,["label"]),o(f,{label:e.$t("otherProperties"),name:"otherProperties"},{default:u(()=>[o(he,{ref_key:"propertiesRef",ref:P,"properties-obj":m},null,8,["properties-obj"])]),_:1},8,["label"])]),_:1})]),g("div",Ce,[o(c,{type:"primary",loading:n.value,class:"btn g-mr-12",onClick:R},{default:u(()=>[L(O(e.$t("ok")),1)]),_:1},8,["loading"]),o(c,{type:"ghost",class:"btn",onClick:v},{default:u(()=>[L(O(e.$t("cancel")),1)]),_:1})])])])}}}),Le=ie(Fe,[["__scopeId","data-v-1cea18b6"]]);export{Le as default};
